name: ğŸš€ Release APK

on:
  # Hanya jalan saat push tag versi: git tag v1.0.0 && git push origin v1.0.0
  push:
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '21'

jobs:
  release:
    name: ğŸ·ï¸ Release ${{ github.ref_name }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ·ï¸ Extract version from tag
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          IFS='.' read -r major minor patch <<< "$VERSION"
          CODE=$(( major * 10000 + minor * 100 + patch ))
          echo "code=$CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (code: $CODE)"

      - name: ğŸ“ Update versionCode & versionName
        run: |
          sed -i "s/versionCode [0-9]*/versionCode ${{ steps.version.outputs.code }}/" android/app/build.gradle
          sed -i 's/versionName "[^"]*"/versionName "${{ steps.version.outputs.version }}"/' android/app/build.gradle
          grep -E "versionCode|versionName" android/app/build.gradle

      - name: ğŸ”¨ Build web
        run: npm run build

      - name: ğŸ”„ Cap sync Android
        run: npx cap sync android

      - name: ğŸ”§ Make gradlew executable
        run: chmod +x android/gradlew

      - name: ğŸ“¦ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      # Build signed release (jika keystore ada di secrets)
      - name: ğŸ” Check keystore secret
        id: has_keystore
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ—ï¸ Build signed Release APK
        if: steps.has_keystore.outputs.available == 'true'
        working-directory: android
        env:
          KEYSTORE_BASE64:   ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS:         ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD:      ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > app/gajiku-release.jks
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file="$PWD/app/gajiku-release.jks" \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD" \
            --no-daemon \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m"

      - name: ğŸ—ï¸ Build unsigned Release APK
        if: steps.has_keystore.outputs.available == 'false'
        working-directory: android
        run: |
          ./gradlew assembleRelease \
            --no-daemon \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m"

      # Rename dengan versi
      - name: ğŸ“‹ Rename APK
        run: |
          APK=$(find android/app/build/outputs/apk -name "*.apk" | head -1)
          FINAL="GAJIKU-${{ steps.version.outputs.version }}.apk"
          cp "$APK" "$FINAL"
          echo "apk=$FINAL" >> $GITHUB_ENV
          echo "APK: $FINAL ($(du -sh $FINAL | cut -f1))"

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "GAJIKU ${{ steps.version.outputs.version }}"
          tag_name: ${{ github.ref_name }}
          body: |
            ## ğŸ“± GAJIKU ${{ steps.version.outputs.version }}

            ### â¬‡ï¸ Download & Install
            1. Download file **GAJIKU-${{ steps.version.outputs.version }}.apk**
            2. Di HP: **Setelan â†’ Keamanan â†’ Izinkan sumber tidak dikenal**
            3. Buka file APK â†’ Install â†’ Buka GAJIKU âœ…

            ### ğŸ“‹ Build Info
            - Version: `${{ steps.version.outputs.version }}` (code: `${{ steps.version.outputs.code }}`)
            - Commit: `${{ github.sha }}`
          files: ${{ env.apk }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
